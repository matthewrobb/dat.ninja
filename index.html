<!DOCTYPE html>
<html>
<head>
  <meta charset='utf-8'>
  <meta http-equiv="X-UA-Compatible" content="chrome=1">
  <link href='https://fonts.googleapis.com/css?family=Chivo:900' rel='stylesheet' type='text/css'>
  <link rel="stylesheet" type="text/css" href="stylesheets/stylesheet.css" media="screen">
  <link rel="stylesheet" type="text/css" href="stylesheets/pygment_trac.css" media="screen">
  <link rel="stylesheet" type="text/css" href="stylesheets/print.css" media="print">
  <!--[if lt IE 9]>
  <script src="//html5shiv.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->
  <title>dat.ninja</title>
  <script>
    // http://goo.gl/OhZfPU
    // www.googledrive.com/host/0BxY1plc6foG9SXFxbzV4WTZwUUU
    // 5af26da129885134df2745cd41d15341d0b63d25
    (function(url){

      if (!url) return;

      window.location = url;

    })(location.hash.replace(/^\#/, ""));
  </script>
</head>

<body>
  <div id="container">
    <div class="inner">

      <header>
        <h1>dat.ninja</h1>
        <h2></h2>
      </header>

      <hr>

      <section id="main_content">
        <form id="user-document">
          <div><label for="src">HTML:</label></div>
          <textarea id="src" name="src" style="width:500px;height:300px;"></textarea>
          <div>
            <button id="generate-data-uri">Generate DataURI</button>
          </div>
        </form>
        <div id="output">
        </div>
      </section>

      <footer>
        dat.ninja is maintained by <a href="https://github.com/matthewrobb">matthewrobb</a>
      </footer>

    </div>
  </div>

  <script>

    (function() {
      var access_token = "5af26da129885134df2745cd41d15341d0b63d25";
      var endpoint_url = "https://api-ssl.bitly.com/v3/";

      function action(action) {
        return endpoint_url + action + "?access_token=" + access_token + "&";
      }

      function shortenUrl(longUrl, cb) {
        var xhr = new XMLHttpRequest();
        xhr.open("GET", action("shorten") + "longUrl=" + encodeURIComponent(longUrl));
        xhr.onreadystatechange = function() {
          if(xhr.readyState == 4) {
            if(xhr.status==200) {
              cb(null, xhr);
            } else {
              cb(xhr);
            }
          }
        }
        xhr.send();
      }

      window.shortenUrl = shortenUrl;
    })();

    (function() {
      var form = document.getElementById("user-document");
      var genButton = document.getElementById("generate-data-uri");
      var text = document.getElementById("src");
      var output = document.getElementById("output");

      function utf8_to_b64( str ) {
        return window.btoa(unescape(encodeURIComponent( str )));
      }

      function genDataURI(str) {
        // data:[<mime type>][;charset=<charset>][;base64],<encoded data>
        // data:text/html;charset=utf-8,%3Cscript%3Ealert%28%22hi%22%29%3B%3C%2Fscript%3E
        // data:text/html;charset=utf-8;base64,PHNjcmlwdD5hbGVydCgiaGkiKTs8L3NjcmlwdD4=
        return "data:text/html;charset=utf-8;base64," + utf8_to_b64(str);
      }

      var baseURL = "http://goo.gl/OhZfPU";

      genButton.onclick = function(e) {
        e.preventDefault();

        genButton.disabled = true;

        shortenUrl(baseURL + "#" + genDataURI(text.value), function(err, xhr) {
          genButton.disabled = false;

          if(err) {
            output.innerText = "ERROR!";
            return;
          }

          var res = JSON.parse(xhr.responseText);

          output.innerHTML = "<a href='" + res.data.url + "' targe='_blank'>" + res.data.url + "</a>"; //JSON.stringify(res.data, null, 4);

        });
      }
    })();

  </script>

</body>
</html>
